<html>
<head>
<title>GameShow</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
</head>
<body><CENTER>
<canvas id="cvs" />
<script type="text/javascript">
window.onload = function() {

  var WIDTH, HEIGHT;
  var FIELD_WIDTH, FIELD_HEIGHT;
  const LEFT_OFFSET = 40;
  const RIGHT_OFFSET = 10;
  const TOP_OFFSET = 10;
  const NUM_OF_PEOPLE = 1000;
  const DEFAULT_FONT = "bold 8pt 'Times New Roman'";
  const GRID_DIVIDE = 20;
  var grid_unit_width = 0;
  var grid_unit_height = 0;

  var score = 0;
  var score_on_screen = 0;
  var time_hour = 6;
  var time_minute = 0;
  var time_sec = 0;
  var time_day = 1;
  const time_minute_max = 60;
  const time_sec_max = 50;
  var game_over = false;
  var game_over_touchlock = 0;

  var counter = 0;
  const NUM_OF_BOOTH = 50;
  const NUM_OF_CIRCLE = 100;
  const NUM_OF_LASER = 100;
  const NUM_OF_TEXT_PLAYING = 1000;
  const NUM_OF_TEXT_PLAYED = 1000;
  const NUM_OF_NEWS_PRESSED = 100;
  var tutorial_press_counter = 0;

  var canvas = document.getElementById('cvs');
  if (!canvas.getContext) {
    return false;
  }

  var ctx = canvas.getContext('2d');

  fitCanvasSize();
  window.onresize = fitCanvasSize;

  var Mode = {
    tutorial : 1,
    game : 2,
    gameover : 3
  };

  var GameCateogry = {
    shooting : 0,
    action : 1,
    rpg : 2,
    adventure : 3,
    race: 4,
    puzzle: 5,
    simulation: 6
  };

  var GameCateogryColor = new Array('blue', 'red', 'green', 'gold', 'purple', 'black', 'cyan');
  var GameCateogryText = new Array('Shooting', 'Action', 'RPG', 'Adventure', 'Race', 'Puzzle', 'Simulation');

  var booth_x = new Array(NUM_OF_BOOTH);
  var booth_y =  new Array(NUM_OF_BOOTH);
  var booth_size =  new Array(NUM_OF_BOOTH);
  var booth_gamecategory = new Array(NUM_OF_BOOTH);
  var booth_trend_score = new Array(NUM_OF_BOOTH);
  var booth_news_count = new Array(NUM_OF_BOOTH);
  var booth_life = new Array(NUM_OF_BOOTH);
  var number_of_active_booth = 0;
  const BOOTH_SIZE_MAX = 100;

  var visitor_in_field = new Array(NUM_OF_PEOPLE);
  var visitor_x =  new Array(NUM_OF_PEOPLE);
  var visitor_y =  new Array(NUM_OF_PEOPLE);
  var visitor_gamecategory = new Array(NUM_OF_PEOPLE);
  var visitor_booth_visit_list = new Array(NUM_OF_PEOPLE);
  var visitor_playing = new Array(NUM_OF_PEOPLE);
  var visitor_is_press = new Array(NUM_OF_PEOPLE);
  var visitor_next_booth = new Array(NUM_OF_PEOPLE);

  var exhibitor_x = -1;
  var exhibitor_y = -1;
  var exhibitor_x_click = -1;
  var exhibitor_y_click = -1;
  var exhibitor_booth = -1;
  var exhibitor_move = false;
  var exhibitor_circle_radius_max_pow = -1;
  var exhibitor_x_click_pre = -1;
  var exhibitor_y_click_pre = -1;
  var exhibitor_genre_ripple_counter = 0;
  var Exhibitor_size;

  var genre_switch_circle_x = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_y = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_radius = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_radius_max = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_genre = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_ripples = false;
  var genre_switch_circle_velocity = new Array(NUM_OF_CIRCLE);
  var genre_switch_circle_type = new Array(NUM_OF_CIRCLE);		// 0: ripple by booth, 1: ripple by laser

  var genre_laser_from_x = new Array(NUM_OF_LASER);
  var genre_laser_from_y = new Array(NUM_OF_LASER);
  var genre_laser_to_x = new Array(NUM_OF_LASER);
  var genre_laser_to_y = new Array(NUM_OF_LASER);
  var genre_laser_to_width = new Array(NUM_OF_LASER);	// 0 to 100

  var text_playing_x = new Array(NUM_OF_TEXT_PLAYING);
  var text_playing_y = new Array(NUM_OF_TEXT_PLAYING);
  var text_playing_count = new Array(NUM_OF_TEXT_PLAYING);

  var text_played_x = new Array(NUM_OF_TEXT_PLAYED);
  var text_played_y = new Array(NUM_OF_TEXT_PLAYED);
  var text_played_vy = new Array(NUM_OF_TEXT_PLAYED);
  var text_played_count = new Array(NUM_OF_TEXT_PLAYED);

  var news_pressed_x = new Array(NUM_OF_NEWS_PRESSED);
  var news_pressed_y = new Array(NUM_OF_NEWS_PRESSED);
  var news_pressed_booth = new Array(NUM_OF_NEWS_PRESSED);
  var news_pressed_count = new Array(NUM_OF_NEWS_PRESSED);

  var genre_switch_circle_counter = 0;
  const GENRE_SWITCH_CIRCLE_COUNTER_MAX = 1000;

  var trend_ranking = [];
  var world_awake = 0;
  var game_mode = Mode.tutorial;

  var mouseX, mouseY;
  var touchX = 0;
  var touchY = 0;
  var touchViewCounter = 0;
  var touchHoldElevator = -1;
  var timer;
  var mouse_click = false;
  var moment_x = 0;
  var moment_y = 0;

  var interval = 10;

  var touchstart_mouseX = -1;
  var touchstart_mouseY = -1;
  var touchstartTime = 0;
  var touchTime = 1000;

  var touchVisualizerX = -1;
  var touchVisualizerY = -1;
  var touchVisualizerCounter = 0;

  var tutorial_visitor_counter = 0;
  const tutorial_num_of_genre = 3;
  init_tutorial();

  function fitCanvasSize() {
    var w = document.documentElement.clientWidth;
    var h = document.documentElement.clientHeight - 40;
    canvas.width = w;
    canvas.height = h;

    WIDTH = w;
    HEIGHT = h;
    FIELD_WIDTH = WIDTH - LEFT_OFFSET - RIGHT_OFFSET;
    FIELD_HEIGHT = HEIGHT - TOP_OFFSET * 2;

    grid_unit_width = FIELD_WIDTH / GRID_DIVIDE;
    grid_unit_height = FIELD_HEIGHT / GRID_DIVIDE;
  }

  // ----------------------------------------------------------------
  // mouse or touch

  // mouse
  canvas.onmousedown=function(e){
   if(game_mode == Mode.game){
    adjustLocation(e);
    exhibitor_move = true;
    return false;
  }

  canvas.onmousemove=function(e){
    if(!e) e = window.event;
    moment_x = MouseEventGetMomentX(e);
    moment_y = MouseEventGetMomentY(e);
    move_exhibitor();

    adjustLocation(e);
    return false;
   }
  }

  function MouseEventGetMomentX (mouse_event){
    return (mouse_event.movementX || mouse_event.webkitMovementX || mouse_event.mozMovementX || 0);
  }

  function MouseEventGetMomentY (mouse_event){
    return (mouse_event.movementY || mouse_event.webkitMovementY || mouse_event.mozMovementY || 0);
  }

  canvas.onmouseup=function(e){
   if(game_mode == Mode.game){
    adjustLocation(e);
    exhibitor_move = false;
    exhibitor_x_click_pre = -1;
    exhibitor_y_click_pre = -1;

    return false;
   }
  }

  // for track ball support
  canvas.onclick=function(e){
    ElementRequestPointerLock();
    if(game_mode == Mode.tutorial){
      game_mode = Mode.game;
      init_game();
    }else if(game_mode == Mode.game){
      setExhibitor_laser();
    }else if(game_mode == Mode.gameover){
      game_mode = Mode.tutorial;
      init_tutorial();
    }
  }

  function ElementRequestPointerLock(){
    var list = [
      "requestPointerLock",
      "webkitRequestPointerLock",
      "mozRequestPointerLock"
    ];
    for(var i=0;i < list.length;i++){
      if(canvas[list[i]]){
        canvas[list[i]]();
        return true;
      }
    }
    return false;
  }

  function init_game(){
    score = 0;
    score_on_screen = 0;
    time_hour = 10;
    time_minute = 0;
    time_sec = 0;
    time_day = 1;

    game_over = false;
    game_over_touchlock = 0;
    counter = 0;

    // create booth
    for(var i = 0; i < NUM_OF_BOOTH; i++){
      setRandomBooth(i);
    }

    // Recreate overlapped booth
    var stageCreateTimeout = 0;
    while(BoothOverlap() && stageCreateTimeout < 10){
      for(var i = 0; i < NUM_OF_BOOTH; i++){
        var overlappedBoothNumber = boothInBooth(i);
        while(overlappedBoothNumber > 0 && overlappedBoothNumber != i){
          setRandomBooth(i);
          overlappedBoothNumber = boothInBooth(booth_x[i], booth_y[i], booth_size[i]);
        }
      }
      stageCreateTimeout++;
    }
    number_of_active_booth = NUM_OF_BOOTH;
    update_trend_ranking();
    initForNextDay();
  }

  function init_tutorial(){
    game_over = false;
    game_over_touchlock = 0;
    counter = 0;

    // create booth
    var category_len = tutorial_num_of_genre;
    var booth_size = 100;
    var booth_counter = 0;
    for(var i = 0; i < category_len; i++){
      for(var j = 0; j < 4; j++){
        var x = j * FIELD_WIDTH / 4 + LEFT_OFFSET + FIELD_WIDTH / 4 / 2;
        var y = i * FIELD_HEIGHT / category_len + TOP_OFFSET + FIELD_HEIGHT / category_len / 2;
        var size = booth_size;
        var category = i;
        setBooth(booth_counter, x, y, size, category);
        booth_counter++;
      }
    }
    number_of_active_booth = booth_counter;
    update_trend_ranking();
    initForNextDay();
  }


  function initForNextDay(){
    for(var i = 0; i < NUM_OF_PEOPLE; i++)
    {
      visitor_in_field[i] = false;
      visitor_x[i] =  0;
      visitor_y[i] =  0;
      visitor_gamecategory[i] = 0;
      visitor_booth_visit_list[i] = [];
      visitor_playing[i] = 0;
      visitor_is_press[i] = false;
      visitor_next_booth[i] = -1;
    }

    for(var i = 0; i < NUM_OF_LASER; i++){
      genre_laser_from_x[i] = 0;
      genre_laser_from_y[i] = 0;
      genre_laser_to_x[i] = 0;
      genre_laser_to_y[i] = 0;
      genre_laser_to_width[i] = 0;
    }

    exhibitor_booth = Math.floor(Math.random() * NUM_OF_BOOTH);
    exhibitor_x = booth_x[exhibitor_booth];
    exhibitor_y = booth_y[exhibitor_booth];
    exhibitor_circle_radius_max_pow = 0;
    update_exhibitor_circle_radius_max_pow();

    for(var i = 0; i < NUM_OF_CIRCLE; i++){
      genre_switch_circle_x[i] = 0;
      genre_switch_circle_y[i] = 0;
      genre_switch_circle_radius[i] = 0;
      genre_switch_circle_radius_max[i] = 0;
      genre_switch_circle_genre[i] = 0;
      genre_switch_circle_velocity[i] = 0;
      genre_switch_circle_type[i] = 0;
    }

    for(var i = 0; i < NUM_OF_TEXT_PLAYING; i++){
      text_playing_x[i] = 0;
      text_playing_y[i] = 0;
      text_playing_count[i] = 0;
    }

    for(var i = 0; i < NUM_OF_TEXT_PLAYED; i++){
      text_played_x[i] = 0;
      text_played_y[i] = 0;
      text_played_count[i] = 0;
      text_played_vy[i] = 0;
    }

    for(var i = 0; i < NUM_OF_NEWS_PRESSED; i++){
      news_pressed_x[i] = 0;
      news_pressed_y[i] = 0;
      news_pressed_booth[i] = 0;
      news_pressed_count[i] = 0;
    }

    genre_switch_circle_counter = Math.floor(Math.random() * GENRE_SWITCH_CIRCLE_COUNTER_MAX);
    Exhibitor_size = 200;
    tutorial_press_counter = 0;
  }



  function adjustLocation(e){
    // adjust
    var rect = e.target.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;

    touchVisualizerX = mouseX;
    touchVisualizerY = mouseY;
    touchVisualizerCounter = 30;

    exhibitor_x_click = mouseX;
    exhibitor_y_click = mouseY;

    if(game_over == true && game_over_touchlock == 0){
      init_game();
      game_over = false;
      bgm_stop();
    }
  } // -------------------------

  // Count Max for next visitor in. (Small = Busy)
  function countMaxForNextVisitorIn(){
    var count = Math.floor(Math.random() * 500);
    return count;
  }

  function visitor_fieldin_1stfloor_percentage(){
    var percentage = 80;
    return percentage;
  }

  function visitedBooth(visitor_i, booth_j){
    var result = false;
    for(let booth of visitor_booth_visit_list[visitor_i]){
      if(booth == booth_j){
        result = true;
        break;
      }
    }
    return result;
  }

  function setRandomBooth(i){
    var x = Math.floor(Math.random() * GRID_DIVIDE) * grid_unit_width + LEFT_OFFSET + grid_unit_width / 2;
    var y = Math.floor(Math.random() * GRID_DIVIDE) * grid_unit_height + TOP_OFFSET + grid_unit_height / 2;
    var size = Math.floor(Math.random() * BOOTH_SIZE_MAX) + 5;
    var category = Math.floor(Math.random() * GameCateogry.simulation);
    setBooth(i, x, y, size, category);
  }

  function setBooth(i, x, y, size, category){
    booth_x[i] = x;
    booth_y[i] = y;
    booth_size[i] = size;
    booth_gamecategory[i] = category;
    booth_trend_score[i] = 0;
    booth_news_count[i] = 0;
    booth_life[i] = 100;
  }

  function inBooth(x,y,boothNumber){  // Set boothNumber -1 when x,y is not axis for booth.
    var boothNuminSomeBooth = -1;
    for(var j = 0; j < NUM_OF_BOOTH; j++){
      if(j==boothNumber) continue;
      if((booth_x[j] - booth_size[j] / 2) <= x && x <= (booth_x[j] + booth_size[j] / 2) &&
         (booth_y[j] - booth_size[j] / 2) <= y && y <= (booth_y[j] + booth_size[j] / 2)) {
          boothNuminSomeBooth = j;
        break;
      }
    }
    return boothNuminSomeBooth;
  }

  function boothInBooth(boothNumber){
    var boothInBooth = -1;
    var x = booth_x[boothNumber];
    var y = booth_y[boothNumber];
    var size = booth_size[boothNumber];
    var halfSize = size / 2;

    var topLeft =     inBooth(x - halfSize, y - halfSize, boothNumber);
    var topRight =    inBooth(x + halfSize, y - halfSize, boothNumber);
    var bottomLeft =  inBooth(x - halfSize, y + halfSize, boothNumber);
    var bottomRight = inBooth(x + halfSize, y + halfSize, boothNumber);
    if(topLeft >= 0)     boothInBooth = topLeft;
    if(topRight >= 0)    boothInBooth = topRight;
    if(bottomLeft >= 0)  boothInBooth = bottomLeft;
    if(bottomRight >= 0) boothInBooth = bottomRight;

    return boothInBooth;
  }

  function BoothOverlap(){
    var BoothOverlap = false;
    for(var i = 0; i < NUM_OF_BOOTH; i++){
      var overlappedBoothNumber = boothInBooth(i);
      if( overlappedBoothNumber >= 0){  // Overlapped and it's not the booth itself
          BoothOverlap = true;
          break;
        }
    }
    return BoothOverlap;
  }

  function setLaser(x, y){
    for(var i = 0; i < NUM_OF_LASER; i++){
      if(genre_laser_to_width[i] == 0){
        genre_laser_from_x[i] = booth_x[exhibitor_booth];
        genre_laser_from_y[i] = booth_y[exhibitor_booth];
        genre_laser_to_x[i] = x;
        genre_laser_to_y[i] = y;
        genre_laser_to_width[i] = 1;
        break;
      }
    }
  }

  function setGenreAppeal(x, y, genere, radius_max_pow, type){
    for(var i = 0; i < NUM_OF_CIRCLE; i++){
      if(genre_switch_circle_radius_max[i] == 0){
        genre_switch_circle_x[i] = x;
        genre_switch_circle_y[i] = y;
        genre_switch_circle_radius[i] = 0;
        genre_switch_circle_radius_max[i] = radius_max_pow;
        genre_switch_circle_genre[i] = genere;
        genre_switch_circle_velocity[i] = 3;
        genre_switch_circle_type[i] = type;
        break;
      }
    }
  }

  function setExhibitor_laser(){
    if(booth_life[exhibitor_booth]>10){
      setLaser(exhibitor_x, exhibitor_y);
      booth_life[exhibitor_booth]-=10;
      if(booth_life[exhibitor_booth]<0) booth_life[exhibitor_booth] = 0;
    }
  }

  function setNewsPressed(x, y, booth){
    for(var i = 0; i < NUM_OF_NEWS_PRESSED; i++){
      if(news_pressed_count[i] == 0){
        news_pressed_x[i] = x;
        news_pressed_y[i] = y;
        news_pressed_booth[i] = booth;
        news_pressed_count[i] = 1;
        break;
      }
    }
  }

  function update_trend_ranking(){
    trend_ranking .length = 0;
    for(var i = NUM_OF_BOOTH - 1; i >= 0; i--){
      trend_ranking.push([i, booth_trend_score[i]]);
    }
    trend_ranking.sort((a,b) => {
      return(a[1] - b[1])
    })
    trend_ranking.reverse();
  }

  function update_exhibitor_circle_radius_max_pow(){
    exhibitor_circle_radius_max_pow = booth_trend_score[exhibitor_booth] * 1.5 + 60;
  }

  function setNextBooth(people_index){
    // Find Next Near Booth interested in
    var near_distance = -1;
    for(var j = 0; j < NUM_OF_BOOTH; j++){
      if(world_awake > 0 && visitor_playing[people_index] != 0) break;
      if(visitedBooth(people_index, j)) continue;
      if(booth_gamecategory[j] == visitor_gamecategory[people_index]){
        var distance = Math.pow(visitor_x[people_index] - booth_x[j], 2) + Math.pow(visitor_y[people_index] - booth_y[j], 2);
        if(distance < near_distance || near_distance == -1){
          near_distance = distance;
          visitor_next_booth[people_index] = j;        // nearest booth
        }
      }
    }
    if(near_distance==-1){
      visitor_next_booth[people_index] = -1;        // no next booth
    }
  }

  function move_exhibitor(){
    var move_delay = 1;
    var exhibitor_inBooth = inBooth(exhibitor_x, exhibitor_y, -1);

    if(exhibitor_inBooth != -1 && exhibitor_inBooth !=  exhibitor_booth){
      move_delay = 4;
    }

    for(var i = 0; i < NUM_OF_PEOPLE; i++){
      if(Math.pow(visitor_x[i] - exhibitor_x, 2) + Math.pow(visitor_y[i] - exhibitor_y, 2) < 100){
        move_delay = move_delay * 5;
        break;
      }
    }
    exhibitor_x = exhibitor_x + moment_x * exhibitor_circle_radius_max_pow / 10000 / move_delay;
    exhibitor_y = exhibitor_y + moment_y * exhibitor_circle_radius_max_pow / 10000 / move_delay;

    if(exhibitor_x > WIDTH - RIGHT_OFFSET) exhibitor_x = WIDTH - RIGHT_OFFSET;
    if(exhibitor_x < LEFT_OFFSET) exhibitor_x = LEFT_OFFSET;
    if(exhibitor_y < TOP_OFFSET) exhibitor_y = TOP_OFFSET;
    if(exhibitor_y > HEIGHT - TOP_OFFSET) exhibitor_y = HEIGHT - TOP_OFFSET;
  }

  function setPlayingText(x, y){
    for(var i =0; i < NUM_OF_TEXT_PLAYING; i++){
      if(text_playing_count[i] == 0){
        text_playing_x[i] = x;
        text_playing_y[i] = y;
        text_playing_count[i] = 50;
        break;
      }
    }
  }

  function setPlayedText(x, y){
    for(var i =0; i < NUM_OF_TEXT_PLAYED; i++){
      if(text_played_count[i] == 0){
        text_played_x[i] = x;
        text_played_y[i] = y;
        text_played_count[i] = 170;
        text_played_vy[i] = 2;
        break;
      }
    }
  }

  // DRAW
  function draw(){
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    ctx.textAlign = "center";
    ctx.font = DEFAULT_FONT;
    ctx.lineWidth = 1;

    // Draw Field
    ctx.beginPath();
    ctx.strokeStyle = 'black';
    ctx.rect(LEFT_OFFSET, TOP_OFFSET, FIELD_WIDTH, FIELD_HEIGHT);
    ctx.stroke();

    // Draw booth
    for(var i = 0; i < NUM_OF_BOOTH; i++){
      ctx.beginPath();
      ctx.strokeStyle = GameCateogryColor[booth_gamecategory[i]];
      ctx.rect(booth_x[i]- booth_size[i] / 2, booth_y[i]- booth_size[i] / 2,
      booth_size[i],                         booth_size[i]);
      ctx.textAlign = "left";
      if(game_mode == Mode.tutorial){
        ctx.font = "20pt 'Times New Roman'";
      }else if(game_mode == Mode.game){
        ctx.font = "8pt 'Times New Roman'";
      }
      if(game_mode == Mode.tutorial){
        ctx.fillText(i, booth_x[i]- booth_size[i] / 2, booth_y[i] - booth_size[i] / 2);
      }else if(game_mode == Mode.game){
        ctx.fillText(i + ": " + GameCateogryText[booth_gamecategory[i]], booth_x[i]- booth_size[i] / 2, booth_y[i] - booth_size[i] / 2);
      }
      ctx.textAlign = "right";
      ctx.fillText("Trend: " + booth_trend_score[i], booth_x[i] + booth_size[i] / 2, booth_y[i] + booth_size[i] / 2);
      if(booth_news_count[i] > 0)
        ctx.fillText("News x" + booth_news_count[i], booth_x[i] + booth_size[i] / 2, booth_y[i] - booth_size[i] / 2 + 10);
      ctx.stroke();
      // Life
      ctx.beginPath();
      ctx.strokeStyle = 'green';
      var booth_height = booth_size[i] * booth_life[i] / 100;
      ctx.rect(booth_x[i] + booth_size[i] / 2 + 1, booth_y[i] + booth_size[i] / 2 - booth_height, 1, booth_height);
      ctx.stroke();

      if(game_mode == Mode.tutorial){
        ctx.beginPath();
        ctx.strokeStyle = 'black';
        ctx.textAlign = "left";
        ctx.font = "30pt 'Times New Roman'";
        ctx.fillText(GameCateogryText[booth_gamecategory[i]] + " Booth", LEFT_OFFSET + FIELD_WIDTH / 4 / 2 - booth_size[i] / 2, booth_y[i] - booth_size[i] / 2 - booth_size[i] / 3);
        ctx.stroke();
      }
    }

    // Draw Visitors
    ctx.strokeStyle = 'black';
    for(var i = 0; i < NUM_OF_PEOPLE; i++){
     if(visitor_in_field[i] == true){
      var size = 1;
      ctx.strokeStyle = GameCateogryColor[visitor_gamecategory[i]];
      ctx.beginPath();
      ctx.arc(visitor_x[i], visitor_y[i], 3 * size + Math.abs(visitor_playing[i]/100), 0, Math.PI*2, true);
      if(visitor_is_press[i]){
        ctx.textAlign = "center";
        ctx.font = "8pt 'Times New Roman'";
        ctx.fillText("PRESS", visitor_x[i], visitor_y[i]);
      }
      ctx.stroke();
      ctx.beginPath();
      if(game_mode == Mode.tutorial){
        ctx.strokeStyle = 'black';
        ctx.textAlign = "center";
        ctx.font = "20pt 'Times New Roman'";
        ctx.fillText(GameCateogryText[visitor_gamecategory[i]] + " Game Fan", visitor_x[i], visitor_y[i] - 10);
      }
      ctx.stroke();
     }
    }

    // Draw Exhibitor
    if(Exhibitor_size > 1){Exhibitor_size--;}else{Exhibitor_size = 1}
    var visitor_offset = -5;
    ctx.strokeStyle = 'black';
    ctx.beginPath();
    ctx.arc(exhibitor_x, exhibitor_y + visitor_offset * Exhibitor_size, 3 * Exhibitor_size, 0, Math.PI*2, true);
    ctx.moveTo(exhibitor_x - 5 * Exhibitor_size, exhibitor_y + (6 + visitor_offset) * Exhibitor_size);
    ctx.lineTo(exhibitor_x + 5 * Exhibitor_size, exhibitor_y + (6 + visitor_offset) * Exhibitor_size);

    ctx.moveTo(exhibitor_x, exhibitor_y + (3 + visitor_offset) * Exhibitor_size);
    ctx.lineTo(exhibitor_x, exhibitor_y + (8 + visitor_offset) * Exhibitor_size);

    ctx.moveTo(exhibitor_x,            exhibitor_y + (8 + visitor_offset) * Exhibitor_size);
    ctx.lineTo(exhibitor_x - 4 * Exhibitor_size, exhibitor_y + (11 + visitor_offset) * Exhibitor_size);

    ctx.moveTo(exhibitor_x,            exhibitor_y + (8 + visitor_offset) * Exhibitor_size);
    ctx.lineTo(exhibitor_x + 4 * Exhibitor_size, exhibitor_y + (11 + visitor_offset) * Exhibitor_size);
    ctx.stroke();

    // Draw Exhibitor - booth line
    ctx.beginPath();
    ctx.globalAlpha = 0.1;
    ctx.moveTo(exhibitor_x, exhibitor_y);
    ctx.lineTo(booth_x[exhibitor_booth], booth_y[exhibitor_booth]);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // Draw Exhibitor guide circle
    ctx.beginPath();
    ctx.strokeStyle = 'gray';
    ctx.arc(exhibitor_x, exhibitor_y, exhibitor_circle_radius_max_pow, 0, Math.PI*2, true);
    ctx.stroke();

    // Draw and move Genere Appeal (Circle)
    for(var i = 0; i < NUM_OF_CIRCLE; i++){
      if(genre_switch_circle_radius_max[i] > 0){
        ctx.beginPath();
        ctx.strokeStyle = GameCateogryColor[genre_switch_circle_genre[i]];
        ctx.arc(genre_switch_circle_x[i], genre_switch_circle_y[i], genre_switch_circle_radius[i], 0, Math.PI*2, true);
        if (genre_switch_circle_type[i]==0){  // 0: genre ripple by booth, 1: booth ripple by laser
        }else{
          ctx.fillStyle = GameCateogryColor[genre_switch_circle_genre[i]];
          ctx.fill();
        }
        ctx.stroke();
        ctx.lineWidth = 1.0;
        genre_switch_circle_radius[i]+= genre_switch_circle_velocity[i];
        if(genre_switch_circle_velocity[i] > 0.7)
          genre_switch_circle_velocity[i] -= 0.05;
        if(genre_switch_circle_radius[i] > genre_switch_circle_radius_max[i]){
          genre_switch_circle_radius_max[i] = 0;  // OFF
        }
        if(game_mode == Mode.tutorial){
          ctx.beginPath();
          ctx.strokeStyle = 'black';
          ctx.textAlign = "center";
          ctx.font = "40pt 'Times New Roman'";
          ctx.fillText("Genre Appeal", genre_switch_circle_x[i], genre_switch_circle_y[i] - genre_switch_circle_radius[i]);
          ctx.fillText("Genre Appeal", genre_switch_circle_x[i], genre_switch_circle_y[i] + genre_switch_circle_radius[i]);
          ctx.stroke();
        }
      }
    }

    // Draw Time
    ctx.fillStyle = 'rgba(0, 0, 0)';
    var time_size = 1;  // 0-1
    var time_hold = 5;
    if(time_minute == 0){
       time_size = 1 - (time_sec_max - time_sec) / time_sec_max;
    }else if(time_minute < time_hold){
       time_size = 1;
    }else if(time_minute < 12){
       var ten_minute_max = (12 - time_hold) * time_sec_max;
       time_size = (ten_minute_max - (time_minute - (time_hold - 1)) * time_sec_max + (time_sec_max - time_sec)) / ten_minute_max;
    }else{
       time_size = 0;
    }
    ctx.font = 10 + 10 * time_size + "pt 'Times New Roman'";
    var text_minutes;
    if(time_minute < 10){
      text_minutes = "0" + time_minute;
    }else{
      text_minutes = time_minute;
    }
    if(time_hour < 12){
      ctx.fillText("Day " + time_day + " AM " + time_hour + ":" + text_minutes, LEFT_OFFSET + FIELD_WIDTH / 2, TOP_OFFSET + (TOP_OFFSET + FIELD_HEIGHT / 4) * time_size);
    }else{
      ctx.fillText("Day " + time_day + " PM " + (time_hour - 12)  + ":" + text_minutes, LEFT_OFFSET + FIELD_WIDTH / 2, TOP_OFFSET + (TOP_OFFSET + FIELD_HEIGHT / 4) * time_size);
    }
    ctx.font = DEFAULT_FONT;

    // Draw Score
    score = booth_trend_score[exhibitor_booth];
    if(score > score_on_screen) score_on_screen++;
    ctx.textAlign = "left";
    ctx.font = "10pt 'Times New Roman'";
    ctx.fillText("SCORE: " + score_on_screen + "  News: " + booth_news_count[exhibitor_booth], LEFT_OFFSET, TOP_OFFSET);
    ctx.textAlign = "center";

    if(game_over_touchlock > 0) game_over_touchlock--;
    if(game_over == true){
        ctx.fillStyle = "#E9967A";
        ctx.font = 40 + "pt 'Times New Roman'";
        ctx.fillText("Game Over", WIDTH / 2, HEIGHT / 2);

        if(game_over_touchlock == 0){
          ctx.font = 30 + "pt 'Times New Roman'";
          ctx.fillText("Tap to replay", WIDTH / 2, HEIGHT * 2 / 3);
        }
        score_on_screen = score;
       return;
    }

    // Draw Trend Ranking
    var trend_rank_text_y = 0;
    ctx.beginPath();
    ctx.textAlign = "left";
    ctx.font = "10pt 'Times New Roman'";
    ctx.fillText("Trend", 0, TOP_OFFSET + 20);
    for(var i = 0; i < number_of_active_booth; i++){
      if(trend_ranking[i][0]==exhibitor_booth){
        ctx.fillStyle = "red";
        trend_rank_text_y = TOP_OFFSET + 35 + i * 15;
      }else{
        ctx.fillStyle = "black";
      }
      ctx.fillText(trend_ranking[i][0] + ": " + trend_ranking[i][1], 0, TOP_OFFSET + 35 + i * 15);
    }
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = 'black';	    // Draw rank - booth line
    ctx.globalAlpha = 0.1;
    ctx.moveTo(0, trend_rank_text_y);
    ctx.lineTo(booth_x[exhibitor_booth], booth_y[exhibitor_booth]);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // Draw World Arake
    if(world_awake > 0){
      ctx.beginPath();
      ctx.textAlign = "center";
      ctx.font = "50pt 'Times New Roman'";
      ctx.fillStyle = "red";
      ctx.fillText("World Awake", FIELD_WIDTH / 2 , TOP_OFFSET + FIELD_HEIGHT / 2);
      ctx.fillText(world_awake, FIELD_WIDTH / 2 , TOP_OFFSET + FIELD_HEIGHT / 2 + 70);
      ctx.stroke();
      world_awake--;
      if(world_awake == 0){ // reset
        for( var i = 0; i < NUM_OF_PEOPLE; i++){
          visitor_playing[i] = 0;
          setNextBooth(i);
        }
      }
    }

    // draw appeal lazer
    for(var i = 0; i < NUM_OF_LASER; i++){
      if(genre_laser_to_width[i] != 0){
        ctx.strokeStyle = GameCateogryColor[booth_gamecategory[exhibitor_booth]];
        ctx.beginPath();
        var line_to_x = (genre_laser_to_x[i] - genre_laser_from_x[i]) * genre_laser_to_width[i] / 100 + genre_laser_from_x[i];
        var line_to_y = (genre_laser_to_y[i] - genre_laser_from_y[i]) * genre_laser_to_width[i] / 100 + genre_laser_from_y[i];
        ctx.moveTo(genre_laser_from_x[i], genre_laser_from_y[i]);
        ctx.lineTo(line_to_x, line_to_y);
        ctx.stroke();
        genre_laser_to_width[i]++;
        if(genre_laser_to_width[i]>100){
          setGenreAppeal(genre_laser_to_x[i], genre_laser_to_y[i], booth_gamecategory[exhibitor_booth], exhibitor_circle_radius_max_pow, 1/* by laser */);
          genre_laser_to_width[i] = 0;		// reset
        }
      }
    }

    // Draw text
    for(var i = 0; i < NUM_OF_TEXT_PLAYING; i++){
      if(text_playing_count[i] > 0){
        ctx.beginPath();
        ctx.textAlign = "center";
        ctx.font = "15pt 'Times New Roman'";
        ctx.fillStyle = "green";
        if(game_mode == Mode.tutorial){
          ctx.fillText("Playing♪", text_playing_x[i], text_playing_y[i] );
　　　　 }else{
          ctx.fillText("♪", text_playing_x[i], text_playing_y[i] );
        }
        ctx.stroke();
        text_playing_y[i]--;
        text_playing_count[i]--;
      }
    }

    for(var i = 0; i < NUM_OF_TEXT_PLAYED; i++){
      if(text_played_count[i] > 0){
        ctx.beginPath();
        ctx.textAlign = "center";
        ctx.font = "25pt 'Times New Roman'";
        ctx.fillStyle = "red";
        ctx.fillText("Played", text_played_x[i], text_played_y[i] );
        ctx.stroke();
        text_played_y[i]-=text_played_vy[i];
        if(text_played_vy[i] > 0) text_played_vy[i]-=0.02;
        text_played_count[i]--;
      }
    }

    // Draw News Pressed
    var OFFSET_UNIT_X = FIELD_WIDTH / 8;
    var OFFSET_UNIT_Y = FIELD_HEIGHT / 10;
    var text_size = 40;
    for(var i = 0; i < NUM_OF_NEWS_PRESSED; i++){
      var offset_x = i * OFFSET_UNIT_X;
      var offset_y = i * OFFSET_UNIT_Y;
      var news_x1 = FIELD_WIDTH / 8 + offset_x;
      var news_y1 = FIELD_HEIGHT / 8 + offset_y;
      var news_x2 = FIELD_WIDTH / 2 + offset_x;
      var news_y2 = FIELD_HEIGHT / 2 + offset_y;
      if(news_pressed_count[i] > 0){
        if(news_pressed_count[i] < 50){
          var x1 = news_x1 + (news_pressed_x[i] - news_x1) / 50 * (50 - news_pressed_count[i]);
          var y1 = news_y1 + (news_pressed_y[i] - news_y1) / 50 * (50 - news_pressed_count[i]);
          var x2 = news_x2 + (news_pressed_x[i] - news_x2) / 50 * (50 - news_pressed_count[i]);
          var y2 = news_y2 + (news_pressed_y[i] - news_y2) / 50 * (50 - news_pressed_count[i]);
          ctx.beginPath();
          ctx.fillStyle = 'rgba(192, 192, 192, 0.5)';
          ctx.fillRect(x1, y1, x2-x1, y2-y1);
          ctx.stroke();
        }
        if(news_pressed_count[i] >= 50 && news_pressed_count[i] < 500 ){
          ctx.beginPath();
          ctx.textAlign = "left";
          ctx.font = text_size + "pt 'Times New Roman'";
          ctx.fillStyle = 'rgba(192, 192, 192, 0.5)';
          ctx.fillRect(news_x1, news_y1, news_x2 - news_x1, news_y2 - news_y1);
          ctx.fillStyle = "white";
          ctx.fillText("NEWS", news_x1, news_y1 + text_size);
          ctx.font = text_size * 2 / 3 + "pt 'Times New Roman'";
          ctx.fillText("Booth No. " + news_pressed_booth[i], news_x1, news_y1 + text_size * 2);
          ctx.fillText("Trend Score: " + booth_trend_score[news_pressed_booth[i]], news_x1, news_y1 + text_size * 3);
          ctx.stroke();
        }
        if(news_pressed_count[i] >= 500 && news_pressed_count[i] < 550){
          var x1 = news_x1 + (news_pressed_x[i] - news_x1) / 50 * (news_pressed_count[i] - 500);
          var y1 = news_y1 + (news_pressed_y[i] - news_y1) / 50 * (news_pressed_count[i] - 500);
          var x2 = news_x2 + (news_pressed_x[i] - news_x2) / 50 * (news_pressed_count[i] - 500);
          var y2 = news_y2 + (news_pressed_y[i] - news_y2) / 50 * (news_pressed_count[i] - 500);
          ctx.beginPath();
          ctx.fillStyle = 'rgba(192, 192, 192, 0.5)';
          ctx.fillRect(x1, y1, x2-x1, y2-y1);
          ctx.stroke();
        }
        news_pressed_count[i]++;
        if(news_pressed_count[i] >= 550){
          news_pressed_count[i] = 0;
        }
      }
    }

    // move Exhibitor
    // refer to move_exhibitor() function. Now not support for touch operation

    // genre switch circle

    for(var c = 0; c < NUM_OF_CIRCLE; c++){
      if(genre_switch_circle_radius_max[c] <= 0 || world_awake > 0) continue;
      for(var i = 0; i < NUM_OF_PEOPLE; i++){
        var visitor_length_pow = Math.pow(genre_switch_circle_x[c] - visitor_x[i], 2) + Math.pow(genre_switch_circle_y[c] - visitor_y[i], 2);
        var circle_length_pow = Math.pow(genre_switch_circle_radius[c], 2);
        if(circle_length_pow > visitor_length_pow){  // visitor is in circle
        var inBooth_num = inBooth(visitor_x[i], visitor_y[i], -1);
          if(inBooth_num < 0){             // Visitor is out of booth
            visitor_gamecategory[i] = genre_switch_circle_genre[c];// replace genre
            if(genre_switch_circle_type[c] == 0){
              setNextBooth(i);
            }else{	/* 1: ripple by laser */
              visitor_next_booth[i] = exhibitor_booth;	// appealed in case of my circle
            }
          }else{							// Visitor is in booth
            if(visitor_gamecategory[i] != genre_switch_circle_genre[c]){ // draw barrier in case that circle and booth category are not same
              ctx.beginPath();
              ctx.fillStyle = 'rgba(192, 192, 192, 0.5)';
              ctx.fillRect(booth_x[inBooth_num]- booth_size[inBooth_num] / 2, booth_y[inBooth_num]- booth_size[inBooth_num] / 2,
                       booth_size[inBooth_num],                         booth_size[inBooth_num]);
              ctx.stroke();
              if(game_mode == Mode.tutorial){
                ctx.beginPath();
                ctx.fillStyle = 'black';
                ctx.textAlign = "center";
                ctx.font = "50pt 'Times New Roman'";
                ctx.fillText("Booth Barrier", booth_x[inBooth_num], booth_y[inBooth_num]);
                ctx.stroke();
              }
            }
          }
        }
      }
    }

    // Set Booth genre appeal circle
    genre_switch_circle_counter--;
    if(genre_switch_circle_counter <= 0){
      var boothToSetCircle = Math.floor(Math.random() * NUM_OF_BOOTH);
      setGenreAppeal(booth_x[boothToSetCircle], booth_y[boothToSetCircle], booth_gamecategory[boothToSetCircle], booth_size[boothToSetCircle] * 5, 0/* by booth */);
      booth_life[boothToSetCircle]-=10;
      if(booth_life[boothToSetCircle]<0) booth_life[boothToSetCircle] = 0;
      genre_switch_circle_counter = Math.floor(Math.random() * GENRE_SWITCH_CIRCLE_COUNTER_MAX);  // set new counter
    }

    // move visitors
   for(var i = 0; i < NUM_OF_PEOPLE; i++){
     if(visitor_in_field[i] == true){

       // move to nearest booth
       if(visitor_next_booth[i] == -1){
         visitor_x[i]--;
       }else if(visitor_playing[i] == 0){  // Not playing
         var x_diff = booth_x[visitor_next_booth[i]] - visitor_x[i];
         var y_diff = booth_y[visitor_next_booth[i]] - visitor_y[i];
         if(x_diff != 0) visitor_x[i] = visitor_x[i] + x_diff / Math.abs(x_diff);
         if(y_diff != 0) visitor_y[i] = visitor_y[i] + y_diff / Math.abs(y_diff);
       }

       if(visitor_x[i] < -100) visitor_in_field[i] = false;	// out of field

       // Keep distance
       for(var k = 0; k < NUM_OF_PEOPLE; k++){  // Keep distance
         if( i != k && visitor_in_field[k] == true && visitor_playing[i] == 0
             && visitor_next_booth[i] == visitor_next_booth[k]){  // Keep distance only for the same next booth
           var distance = Math.pow(visitor_x[i] - visitor_x[k], 2) + Math.pow(visitor_y[i] - visitor_y[k], 2);
           if(distance < 100){ // Near! Keep Distance!
            var x_diff = visitor_x[k] - visitor_x[i];
            var y_diff = visitor_y[k] - visitor_y[i];
            var rand_5 = 3;
            if(inBooth(visitor_x[k],visitor_y[k],-1) < 0)
              rand_5 = Math.floor(Math.random() * 6);
            if(x_diff != 0)
              visitor_x[i] = visitor_x[i] - (x_diff / Math.abs(x_diff)) * rand_5;
            else
              visitor_x[i] = visitor_x[i] - (rand_5 - 3);   // 0 case
            if(y_diff != 0)
              visitor_y[i] = visitor_y[i] - (y_diff / Math.abs(y_diff)) * rand_5;
            else
              visitor_y[i] = visitor_y[i] - (rand_5 - 3);   // 0 case
           }
        }
       }

       // Visit
       var next_booth = visitor_next_booth[i];
       if(Math.abs(booth_x[visitor_next_booth[i]] - visitor_x[i]) < 10 && Math.abs(booth_y[next_booth] - visitor_y[i]) < 10){
         if(visitor_playing[i] % 50 == 0)  setPlayingText(visitor_x[i],visitor_y[i]);
         visitor_playing[i]++;
         if(visitor_playing[i] > 500){       // Played
           setPlayedText(visitor_x[i],visitor_y[i]);
           visitor_booth_visit_list[i].push(next_booth);
           visitor_playing[i] = 0;
           setNextBooth(i);
           if(visitor_is_press[i]){
             booth_trend_score[next_booth] += 10;  // Booth Trend Point Up for press
             booth_news_count[next_booth]++;
             setNewsPressed(visitor_x[i],visitor_y[i],next_booth);
             if(booth_news_count[next_booth] == 5 && next_booth == exhibitor_booth && world_awake == 0){      // World_Awake
               world_awake = 2000;
               booth_news_count[next_booth] = 0;
               for( var i = 0; i < NUM_OF_PEOPLE; i++){
                 visitor_next_booth[i] = exhibitor_booth;
                 visitor_playing[i] = 0;
               }
             }
           }else{
             booth_trend_score[next_booth]++;  // Booth Trend Point Up
           }
           update_trend_ranking();      // update ranking
           if(next_booth == exhibitor_booth){ // update exhibitor_circle_radius_max_pow
             update_exhibitor_circle_radius_max_pow();
           }
         }
       }
     }
   }

    // draw tutoril title
    if(game_mode == Mode.tutorial){
      ctx.beginPath();
      ctx.textAlign = "center";
      ctx.font = "50pt 'Times New Roman'";
      ctx.fillStyle = "Green";
      ctx.fillText("異世界ゲームショウ", FIELD_WIDTH / 2 , TOP_OFFSET + FIELD_HEIGHT / 3);
      ctx.fillText("Another Game Show", FIELD_WIDTH / 2 , TOP_OFFSET + FIELD_HEIGHT *2 / 3);
      ctx.stroke();
    }

    // Time count
    time_sec++;
    if(time_sec > time_sec_max - 1){
      time_minute++;
      time_sec = 0;
      // recover the life
      for(var i = 0; i < NUM_OF_BOOTH; i++){
        booth_life[i]++;
        if(booth_life[i] > 100)booth_life[i]=100;
      }
    }

    if(time_minute > time_minute_max - 1){
      time_hour++;
      time_minute = 0;
    }
    if(time_hour > 18){
      time_day++;
      time_hour = 0;
      initForNextDay();
    }

    ctx.fillStyle = "#000";

    // visitor field in
    if( counter == 0 ){
      for(var i = 0; i < NUM_OF_PEOPLE; i++){
        if(visitor_in_field[i] == false){
          visitor_in_field[i] = true;
          visitor_x[i] =  FIELD_WIDTH;
          visitor_y[i] =  FIELD_HEIGHT / 2;
          if(game_mode == Mode.game){
            visitor_gamecategory[i] = Math.floor(Math.random() * GameCateogry.simulation);
          }else{	// tutorial
            visitor_gamecategory[i] = tutorial_visitor_counter;
            tutorial_visitor_counter++;
            if(tutorial_visitor_counter > tutorial_num_of_genre - 1) tutorial_visitor_counter = 0;
          }
          setNextBooth(i);
          if(game_mode == Mode.tutorial){
            tutorial_press_counter++;
            if(tutorial_press_counter > 3){
              tutorial_press_counter = 0;
              visitor_is_press[i] = true;
            }
          }else{
            if(Math.random() < 0.03){
              visitor_is_press[i] = true;
            }
          }
          break;
        }
      }
    }
    counter++;
    if(game_mode == Mode.tutorial){
      if(counter > 1000) counter = 0;
    }else if(game_mode == Mode.game){
      if(counter > countMaxForNextVisitorIn()) counter = 0;
    }
  }

  var move = function() {
    draw();

    clearTimeout(timer);
    timer = setTimeout(move, interval);
  };

  move();
};
</script>
</CENTER></body>
</html>
